var __hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("jview/cards",function(e){var $,t,n,r,i,s,o,a,u,c,l,d;return $=e("jquery"),d=e("jmodel/topaz"),e("jmodel-plugins/jquery.emerald"),e("jmodel-plugins/emerald.keys"),l=function(e){return function(t){return d.event.after(e).subscribe(t)}},$.target=function(e){return function(t){var n;return n=t.target,e.call($(n))}},r=function(){function e(){this.events=new d.EventRegistry("ready","dispose","current"),this.event("ready").remember(1),this.li=$(this.li?this.li:'<li class="card"/>'),this.li.addClass(this["class"]),this.li.event("click",".close").subscribe(function(e){return function(){return e.event("dispose").raise(e),!1}}(this))}return e.prototype.event=function(e){return this.events.get(e)},e}(),t=function(e){function t(){t.__super__.constructor.call(this),this.events.add("load",d.event.fromAjax(this.load)),this.event("load").subscribe(function(e){return function(t){return e.init(t)}}(this))}return __extends(t,e),t.prototype["class"]="",t.prototype.load=null,t.prototype.get=function(e){return this.event("load").start(e)},t.prototype.init=function(e){return this.li.html(e),this.li.toggleClass("error",$(e).hasClass("error")),this.url=this.li.children("article").data("url"),this.event("ready").raise(this)},t}(r),s=function(){function e(e,t){this.external=e,this.application=t,this.cards=new d.ObservableTypedList(r),this.events=new d.EventRegistry("add","insert","replace","remove","count","ready"),this.event("ready").remember(1),this.cards.events.republish({add:this.event("add"),insert:this.event("insert"),replace:this.event("replace"),remove:this.event("remove")}),d.disjoin(this.cards.event("add"),this.cards.event("insert"),this.cards.event("replace").map(function(e,t){return t})).subscribe(function(e){return function(t){return t.event("ready").subscribe(function(t){return e.event("ready").raise(t)}),t.event("dispose").subscribe(function(t){return e.cards.remove(t)})}}(this))}return e.prototype.event=function(e){return this.events.get(e)},e.prototype.add=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).add.apply(t,e)},e.prototype.insert=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).insert.apply(t,e)},e.prototype.replace=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).replace.apply(t,e)},e.prototype.remove=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).remove.apply(t,e)},e.prototype.get=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).get.apply(t,e)},e.prototype.count=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).count.apply(t,e)},e.prototype.first=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).first.apply(t,e)},e.prototype.each=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],(t=this.cards).each.apply(t,e)},e}(),o=function(){function e(e,t,n){this.cards=e,this.duration=null!=n?n:750,this.element=$(t),this.events=new d.EventRegistry("ready","removed"),this.cards.events.subscribe({add:function(e){return function(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],e.add.apply(e,t)}}(this),insert:function(e){return function(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],e.insert.apply(e,t)}}(this),replace:function(e){return function(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],e.replace.apply(e,t)}}(this),remove:function(e){return function(){var t;return t=1<=arguments.length?__slice.call(arguments,0):[],e.remove.apply(e,t)}}(this)})}return e.prototype.event=function(e){return this.events.get(e)},e.prototype.fold=function(){return this.element.find("li.card").each(function(e,t){return $(t).css({"-webkit-transform":"rotate("+(4*(e%2)-2)+"deg)",left:-1*$(t).position().left+100*e+"px"})})},e.prototype.add=function(e){return 0===e.li.closest("ul.cards").length?e.event("ready").take(1).subscribe(function(t){return function(){return e.li.children().addClass("adding"),l(1)(function(){return t.element.append(e.li),l(1)(function(){return e.li.children().removeClass("adding"),t.event("ready").raise(e)})})}}(this)):this.event("ready").raise(e)},e.prototype.insert=function(e,t){var n;return n=e.li,n.addClass("adding"),0===t?this.element.find("li.card").eq(0).before(n):this.element.find("li.card").eq(t-1).after(n),e.event("ready").take(1).subscribe(function(t){return function(){return l(1)(function(){var r;return r=Math.min(window.innerWidth,n.children("article").outerWidth(!0)),n.css("width",r),l(1)(function(){return n.removeClass("adding"),t.event("ready").raise(e)})})}}(this))},e.prototype.replace=function(e,t){return t.event("ready").take(1).subscribe(function(n){return function(){return e.li.removeClass("zoomed").after(t.li),t.li.removeClass("zoomed"),l(n.duration)(function(){return $("body").animate({scrollLeft:$("body").width()},1e3,function(){return e.li.remove(),t.li.addClass("zoomed"),l(350)(function(){return n.event("ready").raise(t)})})})}}(this))},e.prototype.remove=function(e){var t;return t=e.li,t.children().addClass("removing"),l(this.duration)(function(n){return function(){return t.addClass("removing"),l(1)(function(){return t.remove().removeClass("removing"),t.children().removeClass("removing"),n.event("removed").raise(e)})}}(this))},e}(),c=function(){function e(e,t,n,r){var i;this.cardListView=e,this.offset=null!=r?r:64,this.element=$(t),this.controls=$(n),this.state=new d.ObservableObject({index:{type:Number,defaultValue:0,remember:1,repeat:!0}}),this.state.event("index").subscribe(function(e){return function(t){return e.scrollTo(t)}}(this)),this.state.event("index").subscribe(function(e){return function(t){var n,r;return null!=(n=e.cardListView.cards.get(t))&&"function"==typeof n.event&&null!=(r=n.event("current"))?r.raise():void 0}}(this)),d.conjoin(this.cardListView.element.event("mousedown","li.card"),this.cardListView.element.event("mouseup","li.card")).map(function(e,t){return{target:$(e.target),deltaX:t.screenX-e.screenX,deltaY:t.screenY-e.screenY}}).where(Function.and(function(e){var t;return t=e.target,0===t.closest("a").length},function(e){var t;return t=e.deltaX,t>-3&&3>t},function(e){var t;return t=e.deltaY,t>-3&&3>t})).subscribe(function(e){return function(t){var n,r;return n=t.target,r=n.closest("li.card").index("li.card"),r!==e.state.index()?e.state.index(n.closest("li.card").index("li.card")):void 0}}(this)),i=$(document).event("keydown").where(function(e){var t;return t=e.target,0===$(t).closest("input,select,textarea,[contentEditable=true]").length}),d.disjoin(i.where(d.key(":left")).map(function(){return-1}),i.where(d.key(":right")).map(function(){return 1})).subscribe(function(e){return function(t){return e.state.index(Math.max(0,Math.min(e.cardListView.cards.count()-1,e.state.index()+t))),!1}}(this)),d.disjoin(this.cardListView.event("ready"),this.cardListView.event("removed")).subscribe(function(e){return function(){return e.controls.toggleClass("hidden",1===e.cardListView.cards.count())}}(this)),this.cardListView.event("removed").subscribe(function(e){return function(){return e.state.index(Math.min(e.cardListView.cards.count()-1,e.state.index()+1))}}(this)),this.controls.find("button.zoom").event("click").subscribe(function(e){return function(t){return e.zoom(t)}}(this)),this.cardListView.element.event("click","li.card").subscribe(function(e){return function(t){return e.unzoom(t)}}(this)),this.controls.find("button.close").event("click").subscribe(function(e){return function(){return e.cardListView.cards.remove(function(e){return e.li.index("li.card")>0})}}(this)),d.disjoin(this.cardListView.event("ready"),this.cardListView.event("removed")).subscribe(function(e){return function(){var t;return t=e.cardListView.cards.count(),e.controls.find(".count").text(t+" card"+(1!==t?"s":""))}}(this)),d.disjoin(this.cardListView.event("ready"),this.state.event("index")).map(function(e){return function(){return[e.state.index(),e.cardListView.cards.count()]}}(this)).subscribe(function(e){return function(t){var n,r;return r=t[0],n=t[1],e.controls.find(".previous").toggleClass("disabled",2>n||0===r),e.controls.find(".next").toggleClass("disabled",2>n||r===n-1)}}(this)),d.disjoin(this.controls.find(".previous").event("click").tag(-1),this.controls.find(".next").event("click").tag(1)).where($.target(function(){return!this.hasClass("disabled")})).subscribe(function(e){return function(t,n){return e.state.index(function(e){return e+n})}}(this)),this.controls.find(".list").closest("li").event("click","a").subscribe(function(e){return function(t){var n;return n=t.target,e.state.index($(n).data("index")),e.controls.find(".list").closest("li").children("div").fadeOut(),!1}}(this)),this.controls.find(".list").event("click").subscribe(function(e){return function(t){var n,r,i;return i=t.target,n=$(i).closest("li").children("div"),n.is(":visible")?n.fadeOut():(r=n.children("ul"),r.children().remove(),e.cardListView.cards.each(function(e,t){return r.append($("<li><a data-index='"+t+"' href='#'>"+e.title+"</a></li>"))}),n.fadeIn())}}(this))}return e.offsets=[],e.width=0,e.scrollLeft=0,e.prototype.scrollTo=function(e,t){var n;return null==t&&(t=300),n=this.cardListView.element.find("li.card").eq(e),n.length>0?this.element.stop().animate({scrollLeft:this.element.scrollLeft()+n.position().left+parseInt(n.css("margin-left"),10)+"px"},t):void 0},e.prototype.nudge=function(){var e;return e=this.element.scrollLeft(),this.element.animate({scrollLeft:parseInt(e,10)+200},500,function(t){return function(){return d.event.after(500).subscribe(function(){return t.element.animate({scrollLeft:e},500)})}}(this))},e.prototype.zoom=function(e){return this.element.addClass("zoomed"),this.offsets=[],this.width=0,this.cardListView.element.children("li").each(function(e){return function(t,n){return e.offsets.push($(n).position().left),e.width+=$(n).outerWidth(!0)}}(this)),l(1)(function(e){return function(){var t;return e.scrollLeft=e.element.scrollLeft(),t=e.element.outerWidth()/e.width,e.cardListView.element.css({position:"relative","-webkit-transform":"scale("+t+")",left:e.scrollLeft})}}(this))},e.prototype.unzoom=function(e){var t,n;return t=e.target,this.element.hasClass("zoomed")?(n=$(t).closest("ul.cards > li").index(),this.cardListView.element.css({"-webkit-transform":"none",left:this.scrollLeft-this.offsets[n]+"px"}),l(1)(function(e){return function(){return e.element.removeClass("zoomed")}}(this)),l(350)(function(e){return function(){return e.element.addClass("no_animation"),e.cardListView.element.css("left","0px"),e.element.scrollLeft(Math.min(e.offsets[n],e.width-e.element.width())),l(10)(function(){return e.element.removeClass("no_animation")})}}(this)),!1):void 0},e}(),a=function(){function e(e,t){var n;this.cardType=t,this.keys=function(){var t,r,i,s;for(i=e.match(/\{[^\}]+\}/g)||["id"],s=[],t=0,r=i.length;r>t;t++)n=i[t],s.push(n.replace("{","").replace("}","").replace("?",""));return s}(),this.pattern=new RegExp("^"+String(e).replace("/","/").replace(/\/?\{[^\}]+\?\}/g,"(?:/?([^/]+))?").replace(/\/?\{[^\}]+\}/g,"(?:/?([^/]+))")+"/?$")}return e.prototype.test=function(e){return this.pattern.test(e)},e.prototype.match=function(e){var t,n,r,i,s,o,a,u,c;for(u=this.pattern.exec(e),s=u[0],i=2<=u.length?__slice.call(u,1):[],r={},c=this.keys,t=o=0,a=c.length;a>o;t=++o)n=c[t],r[n]=null!=i?i[t]:void 0;return r},e}(),u=function(){function e(e){this.routes=e}return e.prototype.resolve=function(e){var t,n,r,i,s,o,a,u,c,l,d,h,f,p,v,m;if(f=e.split("#"),e=f[0],t=f[1],p=e.match(/([^\?]*)\??(.*)/),l=p[0],o=p[1],a=p[2],console.log(o),console.log(a),console.log(t),u=function(){var e,t,n,r;for(n=this.routes,r=[],e=0,t=n.length;t>e;e++)u=n[e],u.test(o)&&r.push(u);return r}.call(this)[0])for(n=u.match(o),s={fragment:t},v=function(){var e,t,n,r;for(n=a.split("&"),r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(i.split("="));return r}(),d=0,h=v.length;h>d;d++)m=v[d],r=m[0],c=m[1],s[r]=c;return[null!=u?u.cardType:void 0,n||{},s||{}]},e}(),i=function(){function t(e,t,n,r,i){this.cardList=e,this.view=t,this.viewport=n,this.element=r,this.router=i,$(document).event("click","a[href]").notBetween($(document).event("keydown").where(d.key(":leftcmd",":ctrl")),$(document).event("keyup").where(d.key(":leftcmd",":ctrl"))).subscribe(function(e){return function(t){return e.handle(t,!0)}}(this)),$(document).event("click","a[href]").between($(document).event("keydown").where(d.key(":leftcmd",":ctrl")),$(document).event("keyup").where(d.key(":leftcmd",":ctrl"))).subscribe(function(e){return function(t){return e.handle(t,!1)}}(this))}return t.prototype.handle=function(t,n){var r,i,s,o,a,u,c,l,d,h,f,p,v,m,g,y,b;if(m=t.target,d=function(e){return window.open(e,Date().split(" ").join(""))},r=$(m).closest("a"),i=r.hasClass("before"),u=r.attr("href"),y=u.match(/([^#\?]*)((?:#)[^\?]*)?(\?.*)?/)||[],g=y[0],f=y[1],a=y[2],v=y[3],p=(u.match(/^([^:\?]*):.*/)||["https"])[0],l=r.closest("li.card"),o=0===l.length?$("li.card").length:l.index("li.card")+1,("http"===p||"https"===p)&&(b=this.router.resolve(f),s=b[0],c=b[1],h=b[2]),h=h||{},h.location={protocol:p,path:f,fragment:a,query:v},f===location.origin+location.pathname)return location.hash="#"+a,$(document).scrollTop(0),!1;if(r.attr("download"))return!0;if(r.hasClass("permalink"))return d(u),!1;if(null!=s){if(r.is(".disabled"))return!1;r.addClass("disabled"),e([s],function(e){return function(t){var s;return s=new t(e.cardList,c,void 0,h),s.url=u,s.li.hasClass("singleton")&&l.hasClass("singleton")&&1===e.cardList.count()?e.element.animate({scrollLeft:0},500,function(){return e.cardList.replace(e.cardList.get(0),s)}):e.cardList.insert(o+(i?-1:0),s),n?e.view.event("ready").where(function(e){return e===s}).subscribe(function(){return r.removeClass("disabled"),e.viewport.state.index(s.li.index("li.card"))}):void 0}}(this))}else"#"===u[0]&&"mailto"!==p?history.pushState(null,null,window.location.pathname+u):"mailto"!==p&&"javascript"!==p&&d(u);return"mailto"===p},t}(),n=function(){function t(t,n,r,l){var h,f;this.external=r,this.constructors=l,this.element=$(t),this.menuElement=$(n),this.events=new d.EventRegistry("initialised","ready"),this.event("initialised").remember(1),this.event("ready").remember(1),this.event("ready").subscribe(function(e){return function(){return e.element.removeClass("loading")}}(this)),this.cards=new s(this.external,this),this.router=new u(function(){var e,t;e=this.constructors,t=[];for(f in e)h=e[f],t.push(new a(f,h));return t}.call(this)),this.view=new o(this.cards,this.element),this.viewport=new c(this.view,this.element,this.menuElement,null!=this.external.offset),this.controller=new i(this.cards,this.view,this.viewport,this.element,this.router),this.element.children("li.card").each(function(t){return function(n,r){var i,s,o,a,u;return a=$(r).data("url"),u=t.router.resolve(a),i=u[0],s=u[1],o=u[2],e([i],function(e){return h=new e(t.cards,s,$(r),o),t.cards.add(h),t.viewport.state.index(t.cards.count()),t.cards.cards.count()===t.element.children("li.card").length?(t.cards.each(function(e){return e.event("ready").republish(t.event("ready"))}),t.event("initialised").raise()):void 0})}}(this))}return t.prototype.event=function(e){return this.events.get(e)},t}(),{Card:r,AjaxCard:t,List:s,ListView:o,ViewPort:c,Route:a,Router:u,Controller:i,Application:n}}),define("jview/drag",function(e){var $,t,n,r;return $=e("jquery"),r=e("jmodel/emerald"),e("jmodel-plugins/jquery.emerald"),t=function(){function e(e,t){this.element=$(e),this.extractors=new r.List.fromArray(t),this.element.find("*").attr("draggable",!1),this.element.attr("draggable",!0).event("dragstart").subscribe(function(e){return function(t){var n,r,i;return i=t.originalEvent,n=i.dataTransfer,r=t.target,n.dropEffect="none",e.extractors.each(function(e){var t,i,s;return s=e($(r)),i=s[0],t=s[1],n.setData(i,/json/.test(i)?JSON.stringify(t):t)})}}(this))}return e}(),n=function(){function e(e){var t,n;t=e.element,n=e.types,this.effect=e.effect,this.element=$(t),this.types=new r.List.fromArray(n),this.events=new r.EventRegistry("drop"),r.disjoin(this.element.event("dragenter",{preventDefault:!0}).where(function(e){return function(t){var n;return n=t.originalEvent.dataTransfer,e.accept(n)}}(this)).map(function(){return 1}),this.element.event("dragleave",{preventDefault:!0}).where(function(e){return function(t){var n;return n=t.originalEvent.dataTransfer,e.accept(n)}}(this)).map(function(){return-1}),this.element.event("drop",{preventDefault:!0}).map(function(){return 1})).accumulate(r.plus,0).subscribe(function(e){return function(t){return e.element.toggleClass("over",t>0)}}(this)),this.element.event("dragover",{preventDefault:!0}).map(function(e){var t;return t=e.originalEvent.dataTransfer}).where(function(e){return function(t){return e.accept(t)}}(this)).subscribe(function(e){return function(t){return t.dropEffect=e.effect,!1}}(this)),this.element.event("drop",{stopPropagation:!0}).map(function(e){var t;return t=e.originalEvent.dataTransfer}).subscribe(function(e){return function(t){return e.element.removeClass("over"),e.types.each(function(n){var r;return r=t.getData(n),""!==r?e.event("drop").raise(/json/.test(n)?JSON.parse(r):r,n):void 0}),!1}}(this))}return e.prototype.event=function(e){return this.events.get(e)},e.prototype.accept=function(e){return this.types.exists(function(t){return __indexOf.call(e.types,t)>=0})},e}(),{Source:t,Target:n}}),define("jview/hierarchy",function(e){var $,t,n,r;return $=e("jquery"),r=e("jmodel/topaz"),t=function(){function e(e){this.title=e.title,this.href=e.href,this.tail=e.tail}return e}(),n=function(){function e(e){this.element=$(e)}return e.prototype.renderNodes=function(e,t){return this.element.children("li").filter(function(e){return e>=t}).remove(),this.renderNode(e)},e.prototype.renderNode=function(e){return e&&(this.element.append($("<li/>").append($('<a class="singleton"/>').attr("href",e.href).text(e.title))),e.tail)?this.renderNode(e.tail):void 0},e}(),{Node:t,View:n}}),define("jview/palettes",function(e){var $,t,n;return $=e("jquery"),n=e("jmodel/topaz"),e("jmodel-plugins/jquery.emerald"),t=function(){function e(e,t,r){var i,s,o,a;this.parameters=t,this.constructors=r,this.dl=$(e),this.dt=this.dl.children("dt"),this.state=new n.ObservableObject({current:Number,open:Boolean(!1)},{repeat:!0}),this.palettes=function(){var e,t;e=this.constructors,t=[];for(i in e)s=e[i],o=this.dl.children("dd").filter(i),a=o.prev("dt"),t.push(new s(a,o,this));return t}.call(this),this.dt.event("click").map(function(e){return function(e){var t;return t=e.target,Math.floor($(t).index()/2)}}(this)).subscribe(function(e){return function(t){return e.state.current(t),e.state.open(function(e){return!e})}}(this)),this.state.event("open").subscribe(function(e){return function(t){return e.dt.each(function(n,r){return n!==e.state.current()?$(r).removeClass("open"):$(r).toggleClass("open",t)})}}(this))}return e}(),{Palettes:t}});
//# sourceMappingURL=./jview.js.map