define("jmodel/opal",function(t,e,n,r){function i(t){return typeof t}function o(t,e){return function n(){return t[e].apply(t,arguments)}}function s(){var t=F.call(arguments);return function(){var e=arguments[0],n={};for(var i in t)if(t.hasOwnProperty(i)){var o=t[i]&&t[i].label?t[i].label:i;arguments[0]=e[o]!=r?e[o]:e,n[o]=t[i].apply(null,arguments)}return n}}function a(t,e){return e.bind(t)}function u(){var t=F.call(arguments),e="object"==typeof t[0]?t.shift():null,n=t.shift();return n.apply(e,t)}function c(){var t=arguments;return function(){var e=F.call(arguments),n="object"==typeof e[0]?e.shift():null,r=e.shift();return r.apply(n,t)}}function p(){return function(t,e){return t.add(e)}}function l(t){return function(e,n){return t(n)?e.add(n):e}}function d(t,e,n){return function(r,i){var o=e(i);return t(n?o:i)?r.add(o):r}}function h(t){return V(t)}function f(t){return O.type.eq(t)}function y(t){return function(e){return e instanceof t}}function m(t){return function(e){return function(n){return t(n,e)}}}function g(t,e){return Function.and(W(t),H(e))}function b(t){return t.test.bind(t)}function v(t,e){return Object.extend(e?{}:new _,t)}function _(){}function j(t){var e=Object.construct(t);return function(t){return 0===arguments.length||1===arguments.length&&null===t?null:e.apply(null,arguments)}.extend({nullable:!0})}var O={opal_version:"0.22.0"},F=Array.prototype.slice,x=window.console&&window.console.assert?function Z(t,e){window.console.assert(t,e)}:function te(t,e){if(!t)throw"Opal exception: "+e};Object.extend=Object.extend||function(t,e){for(var n in e)t[n]=e[n];return t},Function.delegate=o,Object.extend(O,{type:i,assert:x,delegateTo:o,copy:v}),x(Function.identity===r,'"identity" already defined'),x(Function.constant===r,'"constant" already defined'),x(Function.argument===r,'"argument" already defined'),x(Function.map===r,'"map" already defined'),Object.extend(Function,{identity:function(t){return t},constant:function(t){return function(){return t}},argument:function(t){return function(){return arguments[t]}},map:function(t){return function(e){return t[e]}}}),Function.identity.displayName="identity",Function.constant.displayName="constant",Function.argument.displayName="argument",Function.map.displayName="map";var T=Function.argument(0),S=Function.argument(1),w=Function.argument(2),E=Function.argument(0),N=Function.argument(1),A=Function.argument(2),P=Function.argument(3),L=Function.argument(4),q=Function.argument(5);Object.extend(O,{identity:Function.identity,constant:Function.constant,argument:Function.argument,first:T,second:S,third:w,_0:E,_1:N,_2:A,_3:P,_4:L,_5:q,map:Function.map}),Function.delegate=function(t){return function(){env=t.call(this),context=env[0],method=env[1],method.apply(context,arguments)}},x(Function.pipe===r,'"pipe" already defined'),x(Function.compose===r,'"compose" already defined'),Object.extend(Function,{pipe:function(t){return 1===arguments.length?t:0===arguments.length?Function.identity:t.then(Function.pipe.apply(null,F.call(arguments,1)))},compose:function(t){return 1===arguments.length?t:0===arguments.length?Function.identity:Function.pipe.apply(null,F.call(arguments).reverse())}}),Function.pipe.displayName="pipe",Function.compose.displayName="compose",Object.extend(O,{pipe:Function.pipe,compose:Function.compose}),x(Function.or===r,'"or" already defined'),x(Function.and===r,'"and" already defined'),x(Function.not===r,'"not" already defined'),Object.extend(Function,{or:function(t){return 1===arguments.length?t:0===arguments.length?Function.constant(!1):t.or(Function.or.apply(null,F.call(arguments,1)))},and:function(t){return 1===arguments.length?t:0===arguments.length?Function.constant(!0):t.and(Function.and.apply(null,F.call(arguments,1)))},not:function(t){return"function"==typeof t?t.not():!t}}),Function.or.displayName="or",Function.and.displayName="and",Function.not.displayName="not",Object.extend(O,{or:Function.or,and:Function.and,not:Function.not}),Function.ordering=Function.or,O.ordering=Function.ordering,x(Function.prototype.as===r,'"as" method already defined'),x(Function.prototype.extend===r,'"as" method already defined'),Object.extend(Function.prototype,{as:function(t){return this.displayName=t,this},extend:function(t){return Object.extend(this,t)}}),Function.prototype.as.displayName="as",Function.prototype.extend.displayName="extend",x(Function.prototype.memo===r,'"delay" method already defined'),Object.extend(Function.prototype,{bind:Function.prototype.bind||function(t){var e=F.call(arguments,1),n=this;return function(){return n.apply(t,e.concat(F.call(arguments)))}},curry:Function.prototype.curry||function(){var t=F.call(arguments),e=this;return function(){return e.apply(this,t.concat(F.call(arguments)))}},except:function(t){var e=this;return function(){try{return e.apply(this,arguments)}catch(n){return t.call(this,n)}}},memo:function(){var t={},e=this.post(function(){t[F.call(arguments,1)]=arguments[0]});return function(){var n=t[F.call(arguments)];return n!==r?n:e.apply(this,arguments)}},delay:Function.prototype.delay||function(t){var e=this,n=F.call(arguments,1);return function(){return setTimeout(e.curry.apply(e,n.concat(F.call(arguments))),t||1)}}}),Function.prototype.bind.displayName="bind",Function.prototype.curry.displayName="curry",Function.prototype.memo.displayName="memo",Function.prototype.delay.displayName="delay",x(Function.prototype.map===r,'"map" method already defined'),Object.extend(Function.prototype,{map:function(t){return this.then(Function.map(t))}}),Function.prototype.map.displayName="map",x(Function.prototype.then===r,'"then" method already defined'),x(Function.prototype.but===r,'"but" method already defined'),Object.extend(Function.prototype,{then:function(t){var e=this;return function(){return t.call(this,e.apply(this,arguments))}},but:function(t){var e=this;return function(){return e.apply(this,arguments),t.apply(this,arguments)}}}),Function.prototype.then.displayName="then",Function.prototype.but.displayName="but",x(Function.prototype.pre===r,'"pre" method already defined'),x(Function.prototype.post===r,'"post" method already defined'),Object.extend(Function.prototype,{pre:function(t){return t.but(this)},post:function(t){var e=this;return function(){var n=e.apply(this,arguments);return t.apply(this,[n].concat(F.call(arguments))),n}}}),Function.prototype.pre.displayName="pre",Function.prototype.post.displayName="post",x(Function.prototype.require===r,'"require" method already defined'),x(Function.prototype.ensure===r,'"ensure" method already defined'),Object.extend(Function.prototype,{require:function(){var t=F.call(arguments),e="string"==typeof t[t.length-1]?t.pop():"",n=Function.and.apply(null,t);return this.pre(function(){if(!n.apply(this,arguments))throw"Precondition failure"+(e?": "+e:"")})},ensure:function(){var t=F.call(arguments),e="string"==typeof t[t.length-1]?t.pop():"",n=Function.and.apply(null,t);return this.post(function(){if(!n.apply(this,arguments))throw"Postcondition failure"+(e?": "+e:"")})}}),Function.prototype.require.displayName="require",Function.prototype.ensure.displayName="ensure",x(Function.prototype.and===r,'"and" method already defined'),x(Function.prototype.or===r,'"or" method already defined'),x(Function.prototype.not===r,'"not" method already defined'),Object.extend(Function.prototype,{and:function(t){var e=this;return function(){return e.apply(this,arguments)&&t.apply(this,arguments)}},or:function(t){var e=this;return function(){return e.apply(this,arguments)||t.apply(this,arguments)}},not:function(){var t=this;return function(){return!t.apply(this,arguments)}}}),Function.prototype.and.displayName="and",Function.prototype.or.displayName="or",Function.prototype.not.displayName="or",x(Function.prototype.is===r,'"is" method already defined'),x(Function.prototype.eq===r,'"eq" method already defined'),x(Function.prototype.neq===r,'"neq" method already defined'),x(Function.prototype.lt===r,'"lt" method already defined'),x(Function.prototype.gt===r,'"gt" method already defined'),x(Function.prototype.lte===r,'"lte" method already defined'),x(Function.prototype.gte===r,'"gte" method already defined'),x(Function.prototype.between===r,'"between" method already defined'),x(Function.prototype.matches===r,'"matches" method already defined'),x(Function.prototype.isnull===r,'"isnull" method already defined'),x(Function.prototype.isa===r,'"isa" method already defined'),x(Function.prototype.hastype===r,'"hastype" method already defined'),Object.extend(Function.prototype,{is:Function.prototype.then,eq:function(t){return this.is(V(t))},neq:function(t){return this.is(B(t))},lt:function(t){return this.is(U(t))},gt:function(t){return this.is(G(t))},lte:function(t){return this.is(H(t))},gte:function(t){return this.is(W(t))},between:function(t,e){return this.is(g(t,e))},matches:function(t){return this.is(b(t))},isnull:function(){return this.then(Y)},isa:function(t){return this.then(y(t))},hastype:function(t){return this.then(f(t))}}),Function.prototype.is.displayName="is",Function.prototype.eq.displayName="eq",Function.prototype.neq.displayName="neq",Function.prototype.lt.displayName="lt",Function.prototype.gt.displayName="gt",Function.prototype.lte.displayName="lte",Function.prototype.gte.displayName="gte",Function.prototype.between.displayName="between",Function.prototype.matches.displayName="matches",Function.prototype.isnull.displayName="isnull",Function.prototype.isa.displayName="isa",Function.prototype.hastype.displayName="hastype",x(Function.prototype.asc===r,'"asc" method already defined'),Object.extend(Function.prototype,{asc:function(){var t=this;return function(e,n){var r=t.call(this,e),i=t.call(this,n);return i>r?-1:r>i?1:0}},desc:function(){return this.asc().then(function(t){return-t})}}),Function.prototype.asc.displayName="asc",x(Function.prototype.create===r,'"create" method already defined'),Object.extend(Function.prototype,{create:function(){return Object.construct(this).apply(null,arguments)}}),Function.prototype.create.displayName="create",x(Object.construct===r,'"construct" method already defined'),x(Object.ensure===r||Object.ensure===Function.prototype.ensure,'"ensure" method already defined'),Object.extend(Object,{construct:function(t){var e=F.call(arguments,1);return t===String?String:t===Number?Number:t===Boolean?Boolean:t===Date?function(){var t=e.concat(F.call(arguments));if(1===t.length&&"string"==typeof t[0]){var n=t[0].split("T"),i=n[0].split("-"),o=n[1]!==r?n[1].split(":"):[];return 0===o.length?new Date(parseInt(i[0],10),parseInt(i[1],10)-1,parseInt(i[2],10)):new Date(parseInt(i[0],10),parseInt(i[1],10)-1,parseInt(i[2],10),parseInt(o[0],10),parseInt(o[1],10),parseInt(o[2],10))}return 1===t.length?new Date(t[0]):3===t.length?new Date(t[0],t[1],t[2]):new Date(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}:t&&t.nullable?t:function(){var n=e.concat(F.call(arguments));return 0===n.length?new t:1===n.length?new t(n[0]):2===n.length?new t(n[0],n[1]):3===n.length?new t(n[0],n[1],n[2]):4===n.length?new t(n[0],n[1],n[2],n[3]):5===n.length?new t(n[0],n[1],n[2],n[3],n[4]):6===n.length?new t(n[0],n[1],n[2],n[3],n[4],n[5]):7===n.length?new t(n[0],n[1],n[2],n[3],n[4],n[5],n[6]):8===n.length?new t(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]):9===n.length?new t(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8]):new t(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9])}},ensure:function(t){var e=Object.construct.apply(null,arguments);return t===String?function(t){return"string"==typeof t?t:String(t)}:t===Number?function(t){return"number"==typeof t?t:Number(t)}:t===Boolean?function(t){return"boolean"==typeof t?t:Boolean(t)}:t&&t.nullable?function(t){return null===t||t===r?null:e.apply(null,arguments)}:function(n){return n instanceof t?n:e.apply(null,arguments)}}}),Object.construct.displayName="construct",Object.ensure.displayName="ensure",Object.extend(O,{construct:Object.construct,ensure:Object.ensure,project:Object.project}),Object.eq=function(t){return function(e){return e===t}},x(Object.project===r,'"project" method already defined'),Object.extend(Object,{copy:function(t){return Object.extend({},t)},equal:function(t,e){if(t===r||e===r)return!1;var n=!0,i;for(i in t)t.hasOwnProperty(i)&&(n=n&&t[i]===e[i]);for(i in e)e.hasOwnProperty(i)&&(n=n&&t[i]===e[i]);return n},remove:function(){var t=F.call(arguments);return function(e){for(var n=Object.copy(e),r=0;r<t.length;r++)delete n[t[r]];return n}},project:function(){var t=F.call(arguments);return function(e){for(var n={},r=0;r<t.length;r++){var i=t[r];e[i]&&(n[i]=e[i])}return n}},rename:function(t){return function(e){var n={};for(var r in e)n[t[r]||r]=e[r];return n}},union:function(t){return 1===arguments.length?Object.copy(t):0===arguments.length?{}:Object.extend(t,Object.union.apply(null,F.call(arguments,1)))},intersection:function(t,e){return 1===arguments.length?Object.copy(t):0===arguments.length?{}:Object.project.apply(null,Object.keys(Object.intersection.apply(null,F.call(arguments,1))))(t)},difference:function(t,e){return Object.remove.apply(null,Object.keys(e))(t)},join:function(t){return function(){return t.apply(null,arguments)?Object.union.apply(null,arguments):r}}}),Object.project.displayName="project",Object.extend(O,{project:Object.project}),x(Object.get===r,'"get" method already defined'),x(Object.set===r,'"set" method already defined'),x(Object.property===r,'"property" method already defined'),x(Object.method===r,'"method" method already defined'),x(Object.resolve===r,'"resolve" method already defined'),x(Object.path===r,'"path" method already defined'),x(Object.transform===r,'"transform" method already defined'),Object.extend(Object,{keys:Object.keys||function(t){var e=[];for(var n in t)e.push(n);return e},get:function(t,e){return e[t]},set:function(t,e,n){return n[t]!==r?(n[t]=e,!0):!1},property:function(t,e){return e===r?Object.get.curry(t):Object.set.curry(t,e)},method:function(t){var e=F.call(arguments,1);return function(n){return"function"==typeof n[t]?n[t].apply(n,e):r}},resolve:function(t){var e=F.call(arguments);return function(n){return"function"==typeof n[t]?Object.method.apply(null,e)(n):Object.property.apply(null,e)(n)}},path:function(t,e){return"string"==typeof t?Object.path.call(null,t.split(e||".")):t===r||0===t.length?Function.constant(r):1===t.length?Object.resolve(t[0]):Object.resolve(t[0]).then(Object.path.call(null,t.slice(1)))},transform:function(t,e,n){var r="function"==typeof n?n.then(e):Object.resolve(t).then(e);return function(e){var n=r(e);return"function"==typeof e[t]?e[t].call(e,n):Object.set(t,n,e)}}}),Object.get.displayName="get",Object.set.displayName="set",Object.property.displayName="property",Object.method.displayName="method",Object.resolve.displayName="resolve",Object.transform.displayName="transform",Object.extend(O,{get:Object.get,set:Object.set,property:Object.property,method:Object.method,resolve:Object.resolve,path:Object.path,transform:Object.transform}),Object.extend(O,{bind:a,apply:u,applyto:c,parallel:s});var M=function(t,e){return t+e}.extend({unit:0,label:"sum"}),k=function(t,e){return t*e}.extend({unit:1,label:"product"}),z=function ee(t){return t=t||Function.constant(!0),function(e,n){return e+=t.call(n,n)?1:0}.extend({unit:0,label:"count"})},I=function ne(t){var e=F.call(arguments,1);return function(n,i){return"function"==typeof n[t]?n[t].apply(n,e.concat(i)):r}},D=I,C=I("push").but(T),Q=function(){switch(arguments.length){case 0:return p.apply(null,arguments);case 1:return l.apply(null,arguments);default:return d.apply(null,arguments)}},K=function(t){return function(e,n){return e||t(n)}.extend({unit:!1})},R=function(t,e){return t>e?t:e}.extend({label:"max"}),J=function(t,e){return e>t&&null!==t?t:e}.extend({label:"min"});Object.extend(O,{plus:M,times:k,count:z,withmethod:I,bymethod:D,push:C,add:Q,contains:K,max:R,min:J}),Object.valid=function(t){return t===Number?isNaN.not():t===Date?function(t){return"Invalid Date"!==t.toString()}:y(t)},Object.has=function(){return Object.resolve.apply(null,arguments).then(Boolean)},Object.extend(O,{valid:Object.valid,is:h,is_of_type:f,isa:y,isan:y,has:Object.has});var V=function(t){return function(e){return e===t}},B=function(t){return function(e){return e!==t}},U=function(t){return function(e){return t>e}},G=function(t){return function(e){return e>t}},H=function(t){return function(e){return t>=e}},W=function(t){return function(e){return e>=t}};Object.extend(O,{compare:m,eq:V,neq:B,lt:U,gt:G,lte:H,gte:W,between:g,regex:b});var X=V(!0),Y=V(null);return Object.extend(O,{AllPredicate:Function.constant(!0),NonePredicate:Function.constant(!1),istrue:X,isnull:Y}),_.from=function(t){return v(t)},_.prototype={constructor:_,addProperties:function(t){return Object.extend(this,t)},removeProperties:function(){for(var t=0;t<arguments.length;t++)delete this[arguments[t]];return this},defaults:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=this[e]||t[e]);return this},setProperty:function(t,e){return this[t]=e,this}},_.prototype._add=_.prototype.addProperties,_.prototype._remove=_.prototype.removeProperties,_.prototype._defaults=_.prototype.defaults,_.prototype._set=_.prototype.setProperty,O.EnhancedObject=_,O.copy=v,Object.extend(O,{Nullable:j}),O}),define("jmodel/sapphire",["jmodel/opal"],function(opal){function _replace(t,e){return e}function delegateTo(t,e){return function n(){return t[e].apply(t,arguments)}}function Map(t,e){this.__rep__=t||{},this.combine=e||_replace}function TypedMap(t,e,n){this.ensure=Object.ensure(t),Map.call(this,null,n);var r=new Map(e),i=this;r.each(function(t,e){i.add2(t,e)})}function Set(t){this.__rep__=t||[],this.length=this.__rep__.length,this.__index=!1,this.added=null}function set(){return 1===arguments.length&&arguments[0]instanceof Set?arguments[0]:1===arguments.length&&arguments[0]&&arguments[0].jquery?Set.fromJQuery(arguments[0]):1===arguments.length&&arguments[0]&&arguments[0].callee?Set.fromArguments(arguments[0]):1===arguments.length&&arguments[0]instanceof Array?Set.fromArray(arguments[0]):Set.fromArguments(arguments)}function zip(t,e,n){return t=t instanceof Set||t instanceof List?t:list(t),e=e.shift?e:e.get(),n="string"==typeof n?method(n):n,t.map(function(t){return n(t,e.shift())})}function TypedSet(t){return this.ensure=Object.ensure(t),this.valid=Object.valid(t),Set.apply(this,[]),Set.fromArray(_slice.call(arguments,1)).reduce(function(t,e){return t.add(e)},this),this}function List(){Set.apply(this,arguments)}function TypedList(){TypedSet.apply(this,arguments)}function list(){return 1===arguments.length&&arguments[0].jquery?List.fromJQuery(arguments[0]):1===arguments.length&&arguments[0].callee?List.fromArguments(arguments[0]):1===arguments.length&&arguments[0]instanceof Array?List.fromArray(arguments[0]):List.fromArguments(arguments)}function UniqueIndex(t,e){this.set=t,this.key="function"==typeof e?e:resolve(e),this.__delegate=copy({},!0),this.build()}function MembershipPredicate(t){return function(e){return t.member(e)}}function CardinalityPredicate(t){return t="function"==typeof t?t:Object.eq(t),Object.method("count").is(t)}function SetPredicate(t){return function(){var e=and.apply(null,arguments);return function(n){return set(n).map(e).reduce(t)}}}function PredicateOrdering(){var t=Set.fromArguments(arguments);return function(e){return-t.count(applyto(e))}.asc()}function NoFormat(t){return t}for(var i in opal)eval("var "+i+" = opal."+i);var _=Object.extend(opal,{sapphire_version:"0.12.0"}),_slice=Array.prototype.slice;_.delegateTo=delegateTo,Map.extend({To:function(t){return TypedMap.curry(t).extend({prototype:TypedMap.prototype})}.memo()}),Map.prototype={get:function(t){return this.__rep__[t]},add:function(t){return 1===arguments.length&&t instanceof Array?this.addArray(t):1===arguments.length&&t instanceof Object?this.addMappings(t):this.add2.apply(this,arguments)},addMappings:function(t){for(var e in t)this.add2(e,t[e]);return this},addArray:function(t){for(var e=0;e<t.length;e++)this.add2(t[e]);return this},add2:function(t,e){var n=this.__rep__[t];this.__rep__[t]=n?this.combine(n,e):e},remove:function(t){return delete this.__rep__[t],this},each:function(){var t=Function.pipe.apply(null,arguments);for(var e in this.__rep__)this.__rep__.hasOwnProperty(e)&&t.call(this,e,this.__rep__[e]);return this}},TypedMap.prototype=Object.extend(new Map,{add2:function(t,e){return Map.prototype.add2.call(this,t,this.ensure.apply(this,_slice.call(arguments,1)))},create:function(t,e){return Map.prototype.add2.call(this,t,this.ensure.apply(this,_slice.call(arguments,1))),this.get(t)}}),Object.extend(_,{Map:Map,TypedMap:TypedMap}),Set.extend({Of:function(t){return TypedSet.curry(t).extend({prototype:TypedSet.prototype})}.memo(),from:function(){return Set.fromArray(_slice.call(arguments))},fromArray:function(t){return new Set(t)},fromArguments:function(t){return Set.fromArray(_slice.call(t))},fromJQuery:function(t){return Set.fromArray(t.get()).map(jQuery).reduce(add(),new Set)},fromGenerator:function(t){for(var e,n=[];"undefined"!=typeof(e=t());)n.push(e);return Set.fromArray(n)},union:function(){return Set.fromArguments(arguments).reduce(bymethod("concat"),new Set)},intersection:function(){return Set.fromArguments(arguments).map(MembershipPredicate).reduce(bymethod("filter"),arguments[0].copy())},difference:function(t,e){return t.filter(not(MembershipPredicate(e)))}}),Set.prototype={__constructor:Set,add:function(t){return this.added=void 0,this.constraint(t)&&(this.__rep__.push(t),this.length++,this.__index&&this.__index.add(t),this.added=t),this},replace:function(t,e){if(this.added=void 0,this.member(t)&&this.constraint(e)){var n=this.__rep__.indexOf(t);this.__rep__[n]=e,this.__index&&this.__index.add(e),this.added=e}return this},remove:function(t){var e=this.partition(this.predicate(t));return this.__rep__=e[!1]?e[!1].get():[],this.length=this.__rep__.length,this.__index&&e[!0]&&e[!0].reduce(bymethod("remove"),this.__index),e[!0]||(this instanceof List?new List:new Set)},sort:function(){return this.__rep__.sort(this.ordering.apply(null,arguments)),this},concat:function(t){return t&&t.reduce?t.reduce(bymethod("add"),this):this},constraint:function(t){return"undefined"!=typeof t&&!this.member(t)},head:function(){return this.__rep__[0]},tail:function(){return this.__constructor.fromArray(this.__rep__.slice(1))},reverse:function(){return this.__constructor.fromArray(this.__rep__.slice().reverse())},get:function(t){return 0===arguments.length?this.__rep__:":first"===t?this.first():":last"===t?this.last():this.__index?this.__index.get(t):"number"==typeof t?this.__rep__[t]:this.first(t)},count:function(t){return 0===arguments.length?this.length:this.reduce(count(t))},first:function(t){return 0===this.length?void 0:"undefined"!=typeof t?this.predicate(t).call(this.head(),this.head())?this.head():this.tail().first(t):this.head()},last:function(t){return 0===this.length?!1:"undefined"!=typeof t?this.reverse().first(t):this.get(this.length-1)},member:Array.prototype.indexOf?function(t){return this.__index?this.__index.member(t):this.__rep__.indexOf(t)>-1}:function(t){return this.__index?this.__index.member(t):"undefined"!=typeof this.first(is(t))},exists:function(t){return 0!=this.count(t)},select:function(t){return t?this.get(t):this},when:function(t,e){return this.predicate(t)(this)&&e.call(this,this),this},each:function(){for(var t=Function.pipe.apply(null,arguments),e=0,n=this.__rep__;e<n.length;e++)t.call(n[e],n[e],e);return this},partition:function(t){var e=this instanceof List?List:Set;return this.reduce(function(n,r){var i=t(r);return n[i]=(n[i]||new e).add(r),n},{})},filter:Array.prototype.filter?function(t){return"undefined"==typeof t?this:this.__constructor.fromArray(this.__rep__.filter(this.predicate(t)))}:function(t){if("undefined"==typeof t)return this;for(var e=[],n=0,r=this.__rep__;n<r.length;n++){var i=r[n];t(i)&&e.push(i)}return this.__constructor.fromArray(e)},map:function(){for(var t=Function.pipe.apply(null,arguments),e=[],n=0,r=this.__rep__;n<r.length;n++)e.push(t.call(r[n],r[n]));return List.fromArray(e)},reduce:Array.prototype.reduce?function(t,e){return this.__rep__.reduce(t,arguments.length>1?e:t.unit)}:function(t,e){e=arguments.length>1?e:t.unit;for(var n=0,r=this.__rep__;n<r.length;n++)e=t(e,r[n]);return e},copy:function(){return this.__constructor.fromArray(this.__rep__.slice(0))},index:function(t){return this.__index=new UniqueIndex(this,t),this},union:function(){return Set.union.apply(null,[this].concat(_slice.call(arguments)))},intersection:function(){return Set.intersection.apply(null,[this].concat(_slice.call(arguments)))},difference:function(t){return Set.difference(this,t)},predicate:function(t){return":empty"===t?empty:t instanceof RegExp?regex(t):"function"==typeof t?t:"string"==typeof t&&":"===t.charAt(0)?is(this.get(t)).extend({unique:!0}):"object"==typeof t&&null!==t||"string"==typeof t||"number"==typeof t?is(t).extend({unique:!0}):Function.constant(!0)},ordering:function(){return arguments.length>1?Function.ordering.apply(null,arguments):arguments[0]instanceof Array?Function.ordering.apply(null,arguments[0]):0===arguments.length?Function.identity.asc():arguments[0]},aggregate:function(t,e){return e=e||null,function n(){var n=arguments.length>1?Function.pipe.apply(null,arguments):arguments[0];return this.map(n||identity).reduce(t,e)}},mean:function(){var t=this.aggregate(parallel(plus,count()),{sum:0,count:0}).apply(this,arguments);return t.sum/t.count},format:function(t){return t(this)},join:function(t){return this.__rep__.join(t)},zip:function(t,e){return zip(this,t,e)},jQuery:function(){return jQuery(this.map(function(t){return t.jquery?t.get():t}).reduce(bymethod("concat"),new this.__constructor).get())},delegateFor:function(t){for(var e in this)t[e]||(t[e]=this[e]);return this}},Set.prototype.where=Set.prototype.filter,Set.prototype.max=Set.prototype.aggregate(Math.max),Set.prototype.min=Set.prototype.aggregate(Math.min),Set.prototype.sum=Set.prototype.aggregate(Math.plus),Set.prototype.range=Set.prototype.aggregate(function(t,e){return e<t[0]?[e,t[1]]:e>t[1]?[t[0],e]:t},[]),_.Set=Set,_.sequence=function(t,e){return t-=e,function(){return t+=e}},_.range=function(t,e){return function(){return e>=t?t++:void 0}},_.set=set,Object.extend(_,{zip:zip}),TypedSet.prototype=Object.extend(new Set,{add:function(){return Set.prototype.add.call(this,this.ensure.apply(this,arguments))},replace:function(t){return Set.prototype.replace.call(this,t,this.ensure.apply(this,_slice.call(arguments,1)))},create:function(){return this.add.apply(this,arguments),this.added}}),_.TypedSet=TypedSet,List.prototype=Object.extend(new Set,{insert:function(t,e){return this.__rep__.splice(t,0,e),this.length++,this.__index&&this.__index.remove(function(){return!0}).build(),this}}),List.prototype.constraint=Function.constant(!0),List.prototype.__constructor=List,TypedList.prototype=Object.extend(new TypedSet,{insert:function(t,e){return this.__rep__.splice(t,0,this.ensure.apply(this,_slice.call(arguments,1))),this.length++,this.__index&&this.__index.remove(function(){return!0}).build(),this}}),TypedList.prototype.constraint=Function.constant(!0),TypedList.prototype.__constructor=TypedList,List.from=function(){return List.fromArray(_slice.call(arguments))},List.fromArray=function(t){return new List(t)},List.fromArguments=function(t){return List.fromArray(_slice.call(t))},List.fromJQuery=function(t){return List.fromArray(t.get()).map(jQuery,new List)},List.fromGenerator=function(t){for(var e,n=[];"undefined"!=typeof(e=t());)n.push(e);return List.fromArray(n)},Object.extend(_,{List:List,list:list,TypedList:TypedList}),UniqueIndex.prototype=Object.extend(Object.copy({}),{__constructor:UniqueIndex,build:function(){this.set.reduce(bymethod("add"),this)},add:function(t){return this.__delegate[this.key(t)]=t,this},remove:function(t){return delete this.__delegate[this.key(t)],this},removeKey:function(t){return delete this.__delegate[t],this},get:function(t){return this.__delegate[t]},member:function(t){return this.__delegate.hasOwnProperty(this.key(t))}}),Object.extend(_,{UniqueIndex:UniqueIndex});var predicate=(new Set).predicate;_.predicate=predicate,_.MembershipPredicate=MembershipPredicate,_.member=MembershipPredicate;var empty=CardinalityPredicate(0),all=SetPredicate(and),some=SetPredicate(or),none=SetPredicate(Object.extend(function(t,e){return t&&!e},{unit:!0}));Object.extend(_,{empty:empty,all:all,some:some,none:none,CardinalityPredicate:CardinalityPredicate});var makeOrdering=(new Set).ordering;return Object.extend(_,{PredicateOrdering:PredicateOrdering,score:PredicateOrdering}),Object.extend(_,{noformat:NoFormat}),_.plugin={set:Set.prototype,typedset:TypedSet.prototype},_}),define("jmodel/emerald",["jmodel/sapphire"],function(sapphire,a,b,c,undefined){function EventRegistry(){Map.To(EventType).apply(this),this.addArray.call(this,_slice.call(arguments))}function EventType(){this.subscribers=delegateTo(new SubscriberSet,"filter"),this.events=[],this.__remember=0}function SwitchCombinator(t){return function(e,n){n=n||{};var r=this.derive(),i=t,o;return this.subscribe(function(){return i?r.raise.apply(r,arguments):(n.remember&&(o=arguments),!0)}),e.subscribe(function(e){return i=!t,i&&n.remember&&o?r.raise.apply(r,o):!0}),r}}function AccumulatorEventType(t,e,n,r){EventType.call(this),n="undefined"!=typeof n?n:e.unit,r&&this.remember(r),t.subscribe({context:this,message:function(){var t=_slice.call(arguments);return n="function"==typeof n?n.apply(null,t):n,n=e.apply(null,[n].concat(t)),this.raise.apply(this,[n].concat(t))}}),this.reset=function(t){n=t,this.raise.call(this,n)}}function match(t,e){return function(){return t.apply(null,arguments)?e.raise.apply(e,arguments):!0}}function AjaxEventType(t,e){EventType.call(this),this.descriptor=Object.copy(t),"object"==typeof e&&(this.description.settings=e),Object.extend(this.descriptor,{success:function(){n.raise.apply(n,_slice.call(arguments).concat(n.descriptor))},error:function(){n.fail.apply(n,_slice.call(arguments).concat(n.descriptor))},beforeSend:function(t,e){jQuery.ajaxSettings.beforeSend&&jQuery.ajaxSettings.beforeSend(t,e)}}),this.descriptor.immediate="undefined"==typeof this.descriptor.immediate?!0:this.descriptor.immediate,this.remember("undefined"!=typeof this.descriptor.remember?this.descriptor.remember:1);var n=this;this.descriptor.immediate&&this.start()}function PeriodicEventType(t,e){EventType.call(this),this.interval=t,this.immediate=e,this.start()}function TimerEventType(t){EventType.call(this),this.interval=t,this.start()}function SubscriberSet(){TypedSet.call(this,Subscriber)}function Subscriber(t){this.subscription="function"==typeof t?{message:t}:t,this.notify=(this.subscription.message||Function.identity).bind(t.context||null),this.fail=(this.subscription.error||Function.identity).bind(t.context||null)}for(var i in sapphire)eval("var "+i+" = sapphire."+i);var em=Object.extend(sapphire,{emerald_version:"0.13.0"}),_=em,_slice=Array.prototype.slice;return EventRegistry.prototype=Object.extend(new(Map.To(EventType)),{register:function(){return this.add(_slice.call(arguments))},create:function(t){return this.add.apply(this,arguments),this.get(t)},subscribe:function(t){for(var e in t)t.hasOwnProperty(e)&&this.get(e).subscribe(t[e]);return this},republish:function(t){for(var e in t)t.hasOwnProperty(e)&&this.get(e).republish(t[e]);return this}}),em.EventRegistry=EventRegistry,em.registry=new EventRegistry,EventType.prototype={__constructor:EventType,subscribe:function t(e){var n=this.subscribers().add(e).added;for(var r in this.events)this.events.hasOwnProperty(r)&&n.notify.apply(n,this.events[r])},raise:function e(){return this.__remember&&(this.events.push(arguments),":all"!==this.__remember&&this.events.length>this.__remember&&this.events.shift()),this.subscribers().notify.apply(this.subscribers(),arguments)},fail:function n(){this.subscribers().fail.apply(this.subscribers(),arguments)},as:function(t){return this.name=t,this},remember:function(t){return this.__remember=t,this
},derive:function(t){var e=new this.__constructor;return e.remember(this.__remember),"function"==typeof t&&this.subscribe({context:e,message:t.call(e,e.raise),error:t.call(e,e.fail)}),e},where:function(){var t=arguments[0].context,e=arguments[0].predicate||(arguments.length>1?and.apply(this,arguments):arguments[0]);return this.derive(function(n){return function(){return e.apply(t||arguments[0],arguments)?n.apply(this,arguments):!0}})},until:function(t,e){var n=!0;return e="undefined"==typeof e?!0:e,this.derive(function(r){return function(){var i=n&&t.apply(null,arguments);return n=n&&!i,n||i&&e?r.apply(this,arguments):!0}})},drop:function(t){return this.derive(function(e){return function(){return--t<0?e.apply(this,arguments):!0}})},take:function(t){return this.derive(function(e){return function(){return t-->0?e.apply(this,arguments):!0}})},between:function(t,e,n){n="object"==typeof n?n:{initial:"undefined"==typeof n?!1:n};var r=n.initial,i,o,s=this.derive(function(t){return function(){return o=_slice.call(arguments),r?t.apply(this,_slice.call(arguments).concat(i)):!0}});return t.subscribe(function(){r===n.initial&&(i=_slice.call(arguments),r=!n.initial)}),e.subscribe(function(){r!==n.initial&&n.inclusive&&s.raise.apply(s,[].concat(o,i,_slice.call(arguments))),r=n.initial}),s},notBetween:function(t,e){return this.between.call(this,t,e,!0)},waitFor:function(t){var e=this.derive(),n=new List,r=!1;return this.subscribe(function(){return r?e.raise.apply(e,arguments):(n.add(_slice.call(arguments)),!0)}),t.subscribe(function(){r=!0,n.each(function(t){e.raise.apply(e,t)})}),e},transition:function(t){t=t||function(t){return t};var e;return this.derive(function(n){return function(){var r=e;return e=t.apply(null,arguments),e!==r?n.call(this,e,r):!0}})},delay:function(t){return this.derive(function(e){return function(){var n=_slice.call(arguments),r=this;setTimeout(function(){e.apply(r,n)},t||0)}})},throttle:function(t){var e,n=new TimerEventType(t),r=this.derive();return this.subscribe(function(){e=_slice.call(arguments),n.stop().start()}),n.subscribe(function(){r.raise.apply(r,e)}),r},effect:function(t){var e=t.context||this;return t=t.fn||t,this.derive(function(n){return function(){return t.apply(e,arguments),n.apply(this,arguments)}})},tag:function(){var t=_slice.call(arguments);return this.derive(function(e){return function(){return e.apply(this,_slice.call(arguments).concat(t))}})},accumulate:function(t,e,n){return new AccumulatorEventType(this,t,e,n?1:0)},map:function(t,e){return t="string"==typeof t?resolve(t):t,this.derive(function(n){return function(){return n.apply(this,e?Set.fromArguments(arguments).map(t).get():[t.apply(null,arguments)])}})},project:function(){var t=Set.fromArguments(arguments);return this.derive(function(e){return function(){var n=arguments;return e.apply(this,t.map(function(t){return n[t]}).get())}})},partition:function(t){var e=new EventRegistry;return this.subscribe(function(){var n=e.ensure(t.apply(null,arguments));return n.raise.apply(n,arguments)}),{event:delegateTo(e,"ensure")}},group:function(t,e,n){var r=this.partition(t),i=new EventRegistry,o=new EventRegistry;return this.subscribe(function(){var s=t.apply(null,arguments),a=i.filter(s);if(!a){var u=r.event(s);return a=i.add("group",u.tag(s).accumulate(e,n)).added,a.republish(o.ensure(s)),u.raise.apply(u,arguments)}return!0}),{event:delegateTo(o,"ensure")}},split:function(){var t=List.fromArguments(arguments);this.subscribe(function(){var e=arguments;t.each(function(t){t.apply(null,e)})})},republish:function(){var t=_slice.call(arguments),e=t.shift();return this.subscribe({message:function(){var n=_slice.call(arguments);return e.raise.apply(e,t.concat(n))},error:function(){var n=_slice.call(arguments);return e.fail.apply(e,t.concat(n))}}),this}},EventType.prototype.async=EventType.prototype.delay,EventType.prototype.before=SwitchCombinator(!0),EventType.prototype.after=SwitchCombinator(!1),em.EventType=EventType,AccumulatorEventType.prototype=new EventType,em.disjoin=function(){var t=new EventType,e=_slice.call(arguments),n=e.length>1&&!(e[e.length-1]instanceof EventType)?e.pop():{},r=e[0]instanceof Set?e[0]:Set.fromArray(e);return t.remember(n.remember||0),r.each(function(e){e.subscribe({message:function(){return t.raise.apply(t,arguments)},error:function(){return t.fail.apply(t,arguments)}})}),t},em.conjoin=function(){function t(){return r.reduce(function(t,e){return t&&e.length>0},!0)}function e(){return n.raise.apply(n,Array.prototype.concat.apply([],r.map(function(t){return t.shift()}).get()))}var n=new EventType,r=list(),i=arguments[0]instanceof Set||arguments[0]instanceof List?arguments[0]:Set.fromArguments(arguments);return i.each(function(n){if(n instanceof EventType){var i=r.add([]).added;n.subscribe(function(){return i.push.call(i,_slice.call(arguments)),t()?e():!0})}}),n},em.match=match,em.event={from:function(t,e,n){var r=new EventType;return jQuery(t).bind(e,function(t){return n&&n.preventDefault&&t.preventDefault(),n&&n.stopPropagation&&t.stopPropagation(),r.raise(t)}),r},fromDelegate:function(t,e,n,r){var i=new EventType;return jQuery(t).on(e,n,function(t){return r&&r.preventDefault&&t.preventDefault(),r&&r.stopPropagation&&t.stopPropagation(),i.raise(t)}),i},after:function(t){return new TimerEventType(t)},every:function(t,e){return new PeriodicEventType(t,e)},fromAsync:function(){var t=new EventType,e=_slice.apply(arguments).concat(function(){t.raise.apply(t,arguments)}),n=e.shift();return t.remember(),n.apply(this,e),t},fromAjax:function(t,e){return new AjaxEventType(t,e)},fromJSON:function(){var t=[jQuery.getJSON].concat(_slice.call(arguments));return em.event.fromAsync.apply(null,t)}},AjaxEventType.prototype=Object.extend(new EventType,{start:function(t){return this.descriptor.singleton&&this.stop(),this.descriptor.data="object"==typeof t?Object.extend(this.descriptor.data||{},t):this.descriptor.data||{},this.__ajax=jQuery.ajax.call(null,this.descriptor),this},stop:function(){return this.__ajax&&this.__ajax.abort&&this.__ajax.abort(),this}}),PeriodicEventType.prototype=Object.extend(new EventType,{start:function(){var t=this;return this.__timer=setInterval(function(){t.raise({})},this.interval),this.immediate&&(this.remember(1),this.raise({})),this},stop:function(){return clearInterval(this.__timer),this}}),TimerEventType.prototype=Object.extend(new EventType,{start:function(){var t=this;return this.__timer=setTimeout(function(){t.raise({})},this.interval),this},stop:function(){return clearTimeout(this.__timer),this}}),em.seconds=function(t){return 1e3*t},em.minutes=function(t){return 6e4*t},em.hours=function(t){return 36e5*t},em.alarm=function(t){var e=Date.parse(t)-(new Date).getTime();return em.event.after(e)},SubscriberSet.prototype=Object.extend(new TypedSet(Subscriber),{add:function(){return TypedSet.prototype.add.apply(this,arguments)},__construct:function(t){return new Subscriber(t)},notify:function r(){var t=arguments;return this.reduce(function(e,n){var r=n.notify.apply(n,t);return e&&(r!==undefined?r:!0)},!0)},fail:function o(t){var e=arguments;this.each(function(t){t.fail.apply(t,e)})}}),em.SubscriberSet=SubscriberSet,Object.extend(em,{Subscriber:Subscriber}),em.changed=function(t){return 1===arguments.length&&arguments[0].value?t.value!==t.old:arguments[0]!==arguments[1]},em}),define("jmodel/topaz",["jmodel/emerald"],function(emerald,a,b,c,undefined){function observable(t){return Object.extend(Object.copy(t,!0),{add:t.add.post(function(){"undefined"!=typeof this.added&&this.event("add").raise(this.added,this)}),replace:t.replace.post(function(t,e,n){"undefined"!=typeof this.added&&this.event("replace").raise(e,n,this)}),remove:t.remove.post(function(t){var e=this;t.each(function(t){e.event("remove").raise(t,e)})}),create:function(){var e=_slice.call(arguments);return t.create.apply(this,[this].concat(arguments))}})}function ObservableSet(t){Set.call(this,t),makeObservable.call(this)}function ObservableTypedSet(t){TypedSet.call(this,t),makeObservable.call(this)}function ObservableList(t){List.call(this,t),makeObservable.call(this)}function ObservableTypedList(t){TypedList.call(this,t),makeObservable.call(this)}function makeObservable(){return this.events=new EventRegistry("add","replace","remove","insert","initialise","sort","change"),this.event=delegateTo(this.events,"get"),disjoin(this.event("add"),this.event("replace"),this.event("insert")).where(Object.has("event","change")).subscribe({context:this.event("change"),message:function(t){t.event("change").republish(this)}}),this}function ObservableObject(t,e){this.options=e||{},this.options.tags=this.options.tags||[],this.fields=[],this.events=new EventRegistry("change"),this.events.addArray(this.options.events||[]),this.event=delegateTo(this.events,"get"),this.event("change").remember(":all");for(var n in t)t.hasOwnProperty(n)&&this.instantiateField(n,t[n])}function Type(t,e){return function(n){ObservableObject.call(this,t,e),this.set(n)}.extend({prototype:new ObservableObject})}function scalar(t){return t="object"==typeof t?t:{defaultValue:t},t.type=t.type||t.defaultValue.constructor,function(e,n){return new ScalarField(e,n,t)}.extend({decorator:!0})}function ScalarField(t,e,n){t&&e&&n&&(this.ensure=Object.ensure(n.type),this.object=t,this.field=e,this.options=n||{},this.constraint=this.options.constraint||Function.constant(!0),this.event=null,this.change=this.object.event("change"),this.instantiate(),this.set("undefined"!=typeof this.options.defaultValue?this.options.defaultValue:undefined),this.toJSON=n.toJSON||undefined,this.object.options.persist&&this.persist())}function object(t){return t="object"==typeof t?t:{defaultValue:t},function(e,n){return new ObjectField(e,n,t)}.extend({decorator:!0})}function ObjectField(t,e,n){ScalarField.call(this,t,e,n)}function many(t){return function(e,n){return new CollectionField(e,n,t)}.extend({decorator:!0})}function CollectionField(t,e,n){ObservableTypedSet.call(this,n),this.object=t,this.field=e,this.__constructor=n,this.instantiate()}for(var i in emerald)eval("var "+i+" = emerald."+i);var topaz=Object.extend(emerald,{topaz_version:"0.13.0"}),_=topaz,_slice=Array.prototype.slice;return ObservableSet.prototype=observable(Set.prototype),ObservableTypedSet.prototype=observable(TypedSet.prototype),ObservableList.prototype=Object.extend(observable(List.prototype),{insert:function(t,e){return this.__rep__.splice(t,0,e),this.length++,this.__index&&this.__index.remove(function(){return!0}).build(),this.event("insert").raise(e,t,this),this}}),ObservableTypedList.prototype=Object.extend(observable(TypedList.prototype),{insert:function(t,e){var n=this.ensure.apply(this,_slice.call(arguments,1));return this.__rep__.splice(t,0,n),this.length++,this.__index&&this.__index.remove(function(){return!0}).build(),this.event("insert").raise(e,t,this),this}}),topaz.ObservableSet=ObservableSet,topaz.ObservableTypedSet=ObservableTypedSet,topaz.ObservableList=ObservableList,topaz.ObservableTypedList=ObservableTypedList,topaz.plugin.set.asObservable=function(){return this.reduce(bymethod("add"),new ObservableSet)},topaz.plugin.typedset.asObservable=function(){return this.reduce(bymethod("add"),new ObservableTypedSet(this.__constructor))},ObservableObject.prototype={__constructor:ObservableObject,instantiateField:function(t,e){e="function"==typeof e&&e.decorator?e:scalar("function"==typeof e?{type:e}:"undefined"!=typeof e.defaultValue?e:{defaultValue:e}),this.fields.push(e.call(this,this,t))},set:function(t){for(var e in t)if(t.hasOwnProperty(e))if("methods"===e){var n=t[e];for(var r in n)n.hasOwnProperty(r)&&(this[r]=n[r])}else this[e]||(console.trace(),console.log(arguments),console.log(this),console.log(e)),this[e].call(this,t[e]);return this}},topaz.ObservableObject=ObservableObject,topaz.Type=Type,topaz.scalar=scalar,ScalarField.prototype={__constructor:ScalarField,instantiate:function(){this.event=this.object.events.create(this.field).remember(this.options.remember||this.object.options.remember);var t=this;this.object[this.field]=function(e){return 0===arguments.length?t.get():t.set(e)}},persist:function(){var t=this.fromStore();t&&this.set(t),this.event.subscribe({context:{store:this.object.options.persist,key:this.object.options.prefix+"_"+this.field},message:function(t){this.store[this.key]=t}})},fromStore:function(){return this.object.options.persist[this.object.options.prefix+"_"+this.field]||undefined},get:function(){return this.value},set:function(t){var e=this.value;return t="function"==typeof t?t.call(this,e):this.ensure.apply(null,arguments),(this.options.repeat||this.object.options.repeat||"undefined"!=typeof t&&!this.equal(t,e))&&(this.constraint(t)?(this.value=t,this.event.raise.apply(this.event,[t,e]),this.change.raise({object:this.object,field:this.field,value:t,old:e})):this.event.fail.apply(this.event,[t,e])),this.object},equal:function(t,e){return t===e}},topaz.ScalarField=ScalarField,topaz.object=object,ObjectField.prototype=Object.extend(new ScalarField,{equal:Object.equal}),topaz.ObjectField=ObjectField,topaz.many=many,CollectionField.prototype=Object.extend(new ObservableTypedSet,{instantiate:function(){this.object[this.field]=delegateTo(this,"filter")}}),topaz.CollectionField=CollectionField,topaz}),define("jmodel/diamond",["jmodel/topaz"],function(topaz,a,b,c,undefined){function Context(t){this.isDefault=!1,this.name=t,this.types=new EntityTypes(this),this.type=delegateTo(this.types,"get"),this.events=new EventRegistry("beginInitialisation","endInitialisation"),this.event=delegateTo(this.events,"get")}function EntityTypes(t){Map.To(EntityType).apply(this),this.ensure=Object.ensure(EntityType,t),this.context=t}function EntityType(t,e,n){var r=-1,o;for(var s in e)e[s].primaryKey&&(o=s,e[s]=e[s]());var a=function(s){if(ObservableObject.call(this,e,n),this.events.add("dirty"),this.events.add("checkpoint"),this.state=new ObservableObject({dirty:Boolean(!1)}),this.state.event("dirty").republish(this.event("dirty")),this.dirty=delegateTo(this.state,"dirty"),s&&(o&&(s[o]=s[o]||r--),this.set(s),a.objects.add(this)),this.context=t,this.entityType=a,this.primaryKeyField=o,o){var u=this[this.primaryKeyField]();this.state.dirty(0>=u||isNaN(u)?!0:!1)}else this.state.dirty(!0);this.checkpoint(),this.event("change").subscribe({context:this,message:function(){var t=!1;for(i in this.__checkpointed)t=t||this[i]()!==this.__checkpointed[i];this.state.dirty(t)}}),this.init()};return a.prototype=n.proto instanceof Entity?n.proto:Object.extend(new Entity,e.methods),a.prototype.checkpoint=function(){this.__checkpointed={};for(i in this.fields)s=this.fields[i],s instanceof ScalarField&&(this.__checkpointed[s.field]=s.get());this.state.dirty(!1),this.event("checkpoint").raise()},a.prototype.checkpointed=function(t){return this.__checkpointed[t]},Object.extend(a.prototype,n.instance||{}),Object.extend(a,di.plugin.type),a.displayName=n.name,a.objects=new Entities(a,n.superType?n.superType.objects:undefined),a.deleted=new Entities(a,n.superType?n.superType.objects:undefined),o&&(a.objects.index(method(o)),a.deleted.index(method(o)),a.objects.event("change").where(property("field").eq(o)).subscribe({context:a.objects,message:function(t){this.__index.removeKey(t.old).add(t.object)}})),a.objects.event("remove").where(method(o).gt(0)).subscribe({context:a.deleted,message:function(t){t._deleted=!0,t.dirty=!0,this.add(t)}}),Object.extend(a,{__constructor:a,options:n,typeName:a.displayName,superType:n.superType,get:delegateTo(a.objects,"get"),create:delegateTo(a.objects,"create"),remove:delegateTo(a.objects,"remove"),object:function(t){return o?(a.objects.get(t[o])||a.create(t)).set(t):a.create(t)},subtype:function(r,i){return t.types.create(EnhancedObject.from(e).addProperties(r).removeProperties("methods"),EnhancedObject.from(n).addProperties(i).addProperties({proto:Object.extend(new a,r.methods),superType:a}))}})}function PrimaryKey(t){return function(){return t}.extend({primaryKey:!0})}function ForeignKey(t){return t}function Decimal(t){return{defaultValue:t||0,type:Number,toJSON:function(){return this.value.toFixed(3)}}}function Entities(t,e){ObservableTypedSet.call(this,t),this.events.add("dirty"),this.events.add("checkpoint"),this.event("change").subscribe({context:this,message:function(){this.event("dirty").raise(0!==this.count(function(t){return t.state.dirty()}))}}),disjoin(this.event("add"),this.event("replace"),this.event("insert")).subscribe({context:this.event("checkpoint"),message:function(t){t.event("checkpoint").republish(this)}})}function Entity(){}for(var i in topaz)eval("var "+i+" = topaz."+i);var di=Object.extend(topaz,{diamond_version:"0.1.0"}),_=di,_slice=Array.prototype.slice,nextKey=-1;return Context.prototype={},di.Context=Context,EntityTypes.prototype=Object.extend(new(Map.To(EventType)),{create:TypedMap.prototype.create.pre(function(t,e,n){n.name=n.name||t})}),di.EntityTypes=EntityTypes,di.plugin.type={},EntityType.prototype={},di.EntityType=EntityType,di.PrimaryKey=PrimaryKey,di.ForeignKey=ForeignKey,di.Decimal=Decimal,Entities.prototype=Object.extend(new ObservableTypedSet,{create:function(t){return this.ensure.apply(null,arguments)},remove:function(t){var e=t instanceof Function?t:t instanceof Entity?identity.eq(t):function n(e){var n=!0;for(var r in t)n=n&&e[r]()==t[r];return n};return ObservableTypedSet.prototype.remove.call(this,e)}}),di.Entities=Entities,Entity.prototype=Object.extend(new ObservableObject,{init:Function.identity}),di.Entity=Entity,di});